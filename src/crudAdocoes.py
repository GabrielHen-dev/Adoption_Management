import json
import os

caminhoArquivoAnimal = "C:..\\Adoption_Management\\data\\Animais.json"
caminhoArquivoAdocoes = "C:..\\Adoption_Management\\data\\Adocoes.json"
caminhoArquivoadotantes = "C:..\\Adoption_Management\\data\\Adotantes.json"

idAdocao = 0
logado = False

if not os.path.exists(caminhoArquivoAdocoes):
    with open(caminhoArquivoAdocoes, 'w') as arquivo:
        json.dump({}, arquivo)

def mostrar_menuAdocoes():
    print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    print("‚ïë       üê± MENU DE ADOCOES üê∂     ‚ïë")
    print("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£")
    print("‚ïë [1] üè† Fazer Login              ‚ïë")
    print("‚ïë [2] üìù Registrar ado√ß√£o         ‚ïë")
    print("‚ïë [3] üìã Listar todas as ado√ß√µes  ‚ïë")
    print("‚ïë [4] üîÑ Atualizar ado√ß√£o         ‚ïë")
    print("‚ïë [5] üß† Ado√ß√£o inteligente       ‚ïë")
    print("‚ïë [6] ‚ùå Remover ado√ß√£o           ‚ïë")
    print("‚ïë [0] ‚Ü©Ô∏è Voltar ao menu principal  ‚ïë")
    print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")

def login_usuario():
    while True:
        global logado
        with open(caminhoArquivoadotantes, 'r') as arquivo:
            try:
                dadosexistentes = json.load(arquivo)
            except json.JSONDecodeError:
                dadosexistentes = {}

        print('=======Login=======')
        cpf = input('Insira seu CPF --> ')
        senha = input('Insira sua senha --> ')

        if cpf in dadosexistentes:

            if senha == dadosexistentes[cpf]['senha']:
                print('Login realizado...')
                logado = True
                break

            else:
                print('Senha Incorreta, tente novamente...')
                logado = False

        else:
            print('- Usu√°rio n√£o cadastrado, tente novamente...')
        continuar = input('\nüîô Pressione enter para continuar.')


def executar_menuAdocoes():
    while True:
        global idAdocao
        global logado
        os.system('cls' if os.name == 'nt' else 'clear')
        mostrar_menuAdocoes()
        escolhaOpcao = int(input('Escolha uma das op√ß√µes: '))

        try:
            escolhaOpcao = int(escolhaOpcao)
        except ValueError:
            print('Por favor, digite um n√∫mero v√°lido.')
            continue

        match(escolhaOpcao):
            case 1:
                if logado == False:
                    login_usuario()
                else:
                    print('Voc√™ j√° est√° logado, voltando ao menu...')
            case 2:
                while True:
                        if logado == True:
                            choice = int(input('Registrar ado√ß√£o, confirma?(1-Sim / 2-N√£o): '))
                            if choice == 1:
                                try:
                                    with open(caminhoArquivoAnimal, 'r') as arquivo:
                                        dadosexistentes = json.load(arquivo)
                                        print("\n---Animais para Ado√ß√£o----\n", json.dumps(dadosexistentes, indent=4))

                                        cpf = input('Insira o seu cpf: ')

                                        with open(caminhoArquivoadotantes, 'r') as arquivo:
                                            dados = json.load(arquivo)


                                        if cpf not in dados:
                                            print('CPF n√£o encontrado ou dados est√£o incorretos.')
                                            break

                                        id_animal = input('Selecione o ID do animal que deseja adotar: ')
                                        with open(caminhoArquivoAnimal, 'r') as arquivo:
                                            dadosExistentes = json.load(arquivo)
                                            if id_animal not in dadosExistentes:
                                                print(f'Id {id_animal} n√£o encontrado')
                                                break

                                        animal_disponivel = True
                                        with open(caminhoArquivoAdocoes, 'r') as arquivo:
                                            adocoes = json.load(arquivo)
                                            for adocao in adocoes.values():
                                                if adocao["id_animal"] == id_animal:
                                                    print('O animal n√£o est√° dispon√≠vel para ado√ß√£o')
                                                    animal_disponivel = False
                                                    break

                                        if not animal_disponivel:
                                            break

                                        usuarios = {
                                            "nome": dados[cpf]["nome"],
                                            "contato": dados[cpf]["contato"],
                                            "email": dados[cpf]["email"]
                                        }

                                        animais = {
                                            "nome": dadosExistentes[id_animal]["Nome"],
                                            "idade": dadosExistentes[id_animal]["Idade"],
                                            "tipo": dadosExistentes[id_animal]["Tipo"],
                                            "ra√ßa": dadosExistentes[id_animal]["Raca"],
                                            "sexo": dadosExistentes[id_animal]["Sexo"]
                                        }


                                        adocao = {
                                            "cpf_adotante": cpf,
                                            "id_animal": id_animal,
                                            "dados_usuario": usuarios,
                                            "dados_animal": animais,
                                            "status-adocao": "Conclu√≠da"
                                        }


                                        try:
                                            with open(caminhoArquivoAdocoes, 'r') as arquivo:
                                                adocoes = json.load(arquivo)
                                        except (FileNotFoundError, json.JSONDecodeError):
                                            adocoes = {}


                                        if adocoes:
                                            proximo_id = max(int(k) for k in adocoes.keys()) + 1
                                        else:
                                            proximo_id = 1

                                        adocoes[str(proximo_id)] = adocao

                                        with open(caminhoArquivoAdocoes, 'w') as arquivo:
                                            json.dump(adocoes, arquivo, indent=4)

                                        print("\n--- Ado√ß√£o realizada com sucesso! ---")
                                        print(f'Seu n√∫mero de Id de ado√ß√£o √© {proximo_id}')
                                        print(f"Animal: {animais["nome"]}")
                                        print(f"Adotante: {usuarios["nome"]}")
                                        print("Detalhes da ado√ß√£o foram armazenados.")
                                        break
                                except Exception as e:
                                    print(f'Ocorreu um erro: {str(e)}')

                            elif choice == 2:
                                print('Voltando ao menu principal...')
                                break

                            else:
                                print('Op√ß√£o inv√°lida, tente novamente...')
                        else:
                            print('Voc√™ n√£o est√° logado, realize o login. Voltando ao menu...')
                            break
            case 3:
                if logado == True:
                    with open(caminhoArquivoAdocoes, 'r') as arquivo:
                        dados = json.load(arquivo)
                        print("\n---Ado√ß√µes registradas----\n", json.dumps(dados, indent=4))
                else:
                    print('Voc√™ n√£o est√° logado, realize o login')
                    print('Voltando ao menu...')

            case 4:
                if logado == True:
                    id = input('Insira o ID da ado√ß√£o: ')
                    with open(caminhoArquivoAdocoes, 'r') as arquivo:
                        adocoes = json.load(arquivo)
                    if id in adocoes:
                        adocoes[id]['status-adocao'] = input('Insira o status da ado√ß√£o: ')
                        print('Salvando altera√ß√£o...')
                        with open(caminhoArquivoAdocoes, 'w') as arquivo:
                            json.dump(adocoes, arquivo, indent=4)
                    else:
                        print('ID n√£o encontrado, tente novamente...')
                else:
                    print('Voc√™ n√£o est√° logado, realize o login')
            case 5:
                cpf = input('Digite o seu cpf: ')
                with open(caminhoArquivoadotantes, 'r') as arquivo:
                    dados = json.load(arquivo)
                if cpf not in dados:
                    print('CPF n√£o encontrado ou dados est√£o incorretos.')
                    break
                preferencias = dados[cpf]['preferencias']
                print("-" * 30)
                print("Suas prefer√™ncias:")
                print(f"Tipo: {preferencias['tipo']}")
                print(f"Porte: {preferencias['porte']}")
                print(f"Sexo: {preferencias['sexo']}")
                print("-" * 30)

                with open(caminhoArquivoAnimal, 'r') as arquivo:
                    dadosExistentes = json.load(arquivo)


                for id_animal, info in dadosExistentes.items():
                    nome = info.get("Nome", "N√£o informado")
                    tipo = info.get("Tipo") or info.get("especie", "N√£o informado")
                    porte = info.get("Porte", "N√£o informado")
                    sexo = info.get("Sexo", "N√£o informado")

                    if (preferencias['tipo'] == tipo and preferencias['porte'] == porte and preferencias['sexo'] == sexo):
                                print('O animal ideal para voc√™:')
                                print(f"Animal ID: {id_animal}")
                                print(f"Nome: {nome}")
                                print(f"Tipo/Esp√©cie: {tipo}")
                                print(f"Porte: {porte}")
                                print(f"Sexo: {sexo}")
                                print("-" * 30)

            case 6:
                if logado == True:
                    id = input('Insira o ID da ado√ß√£o: ')
                    with open(caminhoArquivoAdocoes, 'r') as arquivo:
                        adocoes = json.load(arquivo)
                    if id in adocoes:
                        adocoes.pop(id)
                        with open(caminhoArquivoAdocoes, 'w') as arquivo:
                            json.dump(adocoes, arquivo, indent=4)
                        print('Apagando adocao, voltando ao menu...')
                    else:
                        print('N√£o h√° nenhum ID associado, voltando ao menu...')
                else:
                    print('Voc√™ n√£o est√° logado, realize o login')

            case 0:
                print('Voltando ao menu principal...')
                break
            case _:
                print('Op√ß√£o inv√°lida, tente novamente...')

